require('dotenv').config();
const express = require('express');
const cors = require('cors');
const multer = require('multer');
const path = require('path');
const BedrockService = require('./services/bedrockService');

const app = express();
const PORT = process.env.PORT || 5003;

// BedrockService ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const bedrockService = new BedrockService();

// ë¯¸ë“¤ì›¨ì–´
app.use(cors());
app.use(express.json());
app.use('/uploads', express.static('uploads'));

// í”„ë¡ íŠ¸ì—”ë“œ ì •ì  íŒŒì¼ ì„œë¹™
app.use(express.static(path.join(__dirname, '../front/build')));

// íŒŒì¼ ì—…ë¡œë“œ ì„¤ì •
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, 'uploads/');
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, 'photo-' + uniqueSuffix + path.extname(file.originalname));
  }
});

const upload = multer({
  storage: storage,
  limits: {
    fileSize: 10 * 1024 * 1024 // 10MB ì œí•œ
  }
});

// ê²½ë³µê¶ ê±´ë¬¼ ë°ì´í„° (í…ŒìŠ¤íŠ¸ìš©)
const gyeongbokgungBuildings = {
  // ê²½íšŒë£¨ (ì—°ëª» ìœ„ì˜ ëˆ„ê°)
  gyeonghoeru: {
    id: 'gyeonghoeru',
    name: 'ê²½íšŒë£¨',
    nameEn: 'Gyeonghoeru Pavilion',
    description: 'ê²½ë³µê¶ì˜ ëŒ€í‘œì ì¸ ëˆ„ê°ìœ¼ë¡œ, ì—°ëª» ìœ„ì— ì„¸ì›Œì§„ ì•„ë¦„ë‹¤ìš´ ê±´ë¬¼ì…ë‹ˆë‹¤.',
    detailedDescription: 'ê²½íšŒë£¨ëŠ” ì¡°ì„  íƒœì¢… 12ë…„(1412)ì— ì°½ê±´ë˜ì–´ ì„ì§„ì™œë€ ë•Œ ì†Œì‹¤ëœ í›„ ê³ ì¢… 4ë…„(1867)ì— ì¤‘ê±´ëœ 2ì¸µ ëˆ„ê°ì…ë‹ˆë‹¤. êµ­ì™•ì´ ì‹ í•˜ë“¤ê³¼ ì—°íšŒë¥¼ ë² í’€ê±°ë‚˜ ì™¸êµ­ ì‚¬ì‹ ì„ ì ‘ëŒ€í•˜ë˜ ê³³ìœ¼ë¡œ, ê²½ë³µê¶ì—ì„œ ê°€ì¥ ì•„ë¦„ë‹¤ìš´ ê±´ë¬¼ ì¤‘ í•˜ë‚˜ë¡œ ê¼½í™ë‹ˆë‹¤.',
    coordinates: {
      lat: 37.5788,
      lng: 126.9770
    },
    area: {
      // ê²½íšŒë£¨ ì£¼ë³€ 50m ë°˜ê²½
      center: { lat: 37.5788, lng: 126.9770 },
      radius: 50
    },
    images: ['/image/gyeonghoeru1.jpg', '/image/gyeonghoeru2.jpg'],
    buildYear: '1412ë…„ (íƒœì¢… 12ë…„)',
    culturalProperty: 'êµ­ë³´ ì œ224í˜¸',
    features: ['2ì¸µ ëˆ„ê°', 'ì—°ëª» ìœ„ ê±´ë¬¼', 'ì™•ì‹¤ ì—°íšŒì¥']
  },

  // ê·¼ì •ì „ (ì •ì „)
  geunjeongjeon: {
    id: 'geunjeongjeon',
    name: 'ê·¼ì •ì „',
    nameEn: 'Geunjeongjeon Hall',
    description: 'ê²½ë³µê¶ì˜ ì •ì „ìœ¼ë¡œ, ì¡°ì„  ì™•ì¡°ì˜ ê³µì‹ì ì¸ êµ­ê°€ í–‰ì‚¬ê°€ ì—´ë¦¬ë˜ ê³³ì…ë‹ˆë‹¤.',
    detailedDescription: 'ê·¼ì •ì „ì€ ê²½ë³µê¶ì˜ ì¤‘ì‹¬ ê±´ë¬¼ë¡œ, ì¡°ì„ ì‹œëŒ€ ì™•ì´ ì‹ í•˜ë“¤ì˜ ì¡°íšŒë¥¼ ë°›ê±°ë‚˜ êµ­ê°€ì˜ ì¤‘ìš”í•œ í–‰ì‚¬ë¥¼ ì¹˜ë¥´ë˜ ì •ì „ì…ë‹ˆë‹¤. í˜„ì¬ì˜ ê±´ë¬¼ì€ ê³ ì¢… ë•Œ ì¤‘ê±´ëœ ê²ƒìœ¼ë¡œ, ì¡°ì„  ì™•ì¡°ì˜ ê¶Œìœ„ì™€ ìœ„ì—„ì„ ìƒì§•í•˜ëŠ” ëŒ€í‘œì ì¸ ê±´ì¶•ë¬¼ì…ë‹ˆë‹¤.',
    coordinates: {
      lat: 37.5796,
      lng: 126.9770
    },
    area: {
      center: { lat: 37.5796, lng: 126.9770 },
      radius: 60
    },
    images: ['/image/geunjeongjeon1.jpg', '/image/geunjeongjeon2.jpg'],
    buildYear: '1395ë…„ (íƒœì¡° 4ë…„)',
    culturalProperty: 'êµ­ë³´ ì œ223í˜¸',
    features: ['ì •ì „', 'ì™•ì˜ ì§‘ë¬´ì‹¤', 'êµ­ê°€ í–‰ì‚¬ì¥']
  },

  // ê²½ì„±ì „ (í¸ì „)
  gyeongseungjeon: {
    id: 'gyeongseungjeon',
    name: 'ê²½ì„±ì „',
    nameEn: 'Gyeongseungjeon Hall',
    description: 'ì™•ì´ ì¼ìƒì ì¸ ì •ë¬´ë¥¼ ë³´ë˜ í¸ì „ ê±´ë¬¼ì…ë‹ˆë‹¤.',
    detailedDescription: 'ê²½ì„±ì „ì€ ê·¼ì •ì „ ë¶ìª½ì— ìœ„ì¹˜í•œ í¸ì „ìœ¼ë¡œ, ì™•ì´ í‰ìƒì‹œ ì •ë¬´ë¥¼ ì²˜ë¦¬í•˜ë˜ ê³µê°„ì…ë‹ˆë‹¤. ê·¼ì •ì „ë³´ë‹¤ ì‘ê³  ì‹¤ìš©ì ì¸ êµ¬ì¡°ë¡œ ë˜ì–´ ìˆì–´ ì¼ìƒì ì¸ ì—…ë¬´ì— ì í•©í–ˆìŠµë‹ˆë‹¤.',
    coordinates: {
      lat: 37.5794,
      lng: 126.9768
    },
    area: {
      center: { lat: 37.5794, lng: 126.9768 },
      radius: 40
    },
    images: ['/image/gyeongseungjeon1.jpg'],
    buildYear: '1395ë…„ (íƒœì¡° 4ë…„)',
    culturalProperty: 'ë³´ë¬¼',
    features: ['í¸ì „', 'ì¼ìƒ ì •ë¬´', 'ì‹¤ë¬´ ê³µê°„']
  },

  // ì‚¬ì •ì „ (í¸ì „)
  sajeongjeon: {
    id: 'sajeongjeon',
    name: 'ì‚¬ì •ì „',
    nameEn: 'Sajeongjeon Hall',
    description: 'ì™•ì´ ì¼ìƒì ì¸ ì •ë¬´ë¥¼ ë³´ë˜ í¸ì „ìœ¼ë¡œ, ê·¼ì •ì „ë³´ë‹¤ ì‘ê³  ì‹¤ìš©ì ì¸ ê±´ë¬¼ì…ë‹ˆë‹¤.',
    detailedDescription: 'ì‚¬ì •ì „ì€ ì™•ì´ í‰ìƒì‹œ ì •ë¬´ë¥¼ ë³´ë˜ í¸ì „ìœ¼ë¡œ, ê·¼ì •ì „ì´ ê³µì‹ì ì¸ êµ­ê°€ í–‰ì‚¬ë¥¼ ìœ„í•œ ê³µê°„ì´ë¼ë©´ ì‚¬ì •ì „ì€ ì¼ìƒì ì¸ ì—…ë¬´ë¥¼ ì²˜ë¦¬í•˜ë˜ ì‹¤ë¬´ ê³µê°„ì´ì—ˆìŠµë‹ˆë‹¤.',
    coordinates: {
      lat: 37.5801,
      lng: 126.9770
    },
    area: {
      center: { lat: 37.5801, lng: 126.9770 },
      radius: 40
    },
    images: ['/image/sajeongjeon1.jpg'],
    buildYear: '1395ë…„ (íƒœì¡° 4ë…„)',
    culturalProperty: 'ë³´ë¬¼ ì œ1759í˜¸',
    features: ['í¸ì „', 'ì¼ìƒ ì •ë¬´', 'ì‹¤ë¬´ ê³µê°„']
  },

  // ê°•ë…•ì „ (ì™•ì˜ ì¹¨ì „)
  gangnyeongjeon: {
    id: 'gangnyeongjeon',
    name: 'ê°•ë…•ì „',
    nameEn: 'Gangnyeongjeon Hall',
    description: 'ì¡°ì„ ì‹œëŒ€ ì™•ì˜ ì¹¨ì „ìœ¼ë¡œ ì‚¬ìš©ëœ ê±´ë¬¼ì…ë‹ˆë‹¤.',
    detailedDescription: 'ê°•ë…•ì „ì€ ì¡°ì„ ì‹œëŒ€ ì™•ì´ ê±°ì²˜í•˜ë˜ ì¹¨ì „ìœ¼ë¡œ, ì™•ì˜ ì‚¬ì ì¸ ìƒí™œ ê³µê°„ì´ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ì˜ ê±´ë¬¼ì€ ê³ ì¢… ë•Œ ì¤‘ê±´ëœ ê²ƒì…ë‹ˆë‹¤.',
    coordinates: {
      lat: 37.5804,
      lng: 126.9775
    },
    area: {
      center: { lat: 37.5804, lng: 126.9775 },
      radius: 35
    },
    images: ['/image/gangnyeongjeon1.jpg'],
    buildYear: '1395ë…„ (íƒœì¡° 4ë…„)',
    culturalProperty: 'ë³´ë¬¼ ì œ1760í˜¸',
    features: ['ì™•ì˜ ì¹¨ì „', 'ì‚¬ì  ê³µê°„', 'ìƒí™œ ê³µê°„']
  },

  // êµíƒœì „ (ì™•ë¹„ì˜ ì¹¨ì „)
  gyotaejeon: {
    id: 'gyotaejeon',
    name: 'êµíƒœì „',
    nameEn: 'Gyotaejeon Hall',
    description: 'ì¡°ì„ ì‹œëŒ€ ì™•ë¹„ì˜ ì¹¨ì „ìœ¼ë¡œ ì‚¬ìš©ëœ ê±´ë¬¼ì…ë‹ˆë‹¤.',
    detailedDescription: 'êµíƒœì „ì€ ì¡°ì„ ì‹œëŒ€ ì™•ë¹„ê°€ ê±°ì²˜í•˜ë˜ ì¹¨ì „ìœ¼ë¡œ, ì™•ë¹„ì˜ ì‚¬ì ì¸ ìƒí™œ ê³µê°„ì´ì—ˆìŠµë‹ˆë‹¤. ì•„ë¦„ë‹¤ìš´ ê½ƒë‹´ìœ¼ë¡œë„ ìœ ëª…í•©ë‹ˆë‹¤.',
    coordinates: {
      lat: 37.5807,
      lng: 126.9775
    },
    area: {
      center: { lat: 37.5807, lng: 126.9775 },
      radius: 35
    },
    images: ['/image/gyotaejeon1.jpg'],
    buildYear: '1395ë…„ (íƒœì¡° 4ë…„)',
    culturalProperty: 'ë³´ë¬¼ ì œ1761í˜¸',
    features: ['ì™•ë¹„ì˜ ì¹¨ì „', 'ê½ƒë‹´', 'ì—¬ì„± ê³µê°„']
  }
};

// ê±´ë¬¼ í´ë¦¬ê³¤ ë°ì´í„° (í”„ë¡ íŠ¸ì—”ë“œì™€ ë™ì¼)
const buildingPolygons = [
  {
    id: 'eungjidang',
    name: 'ì‘ì§€ë‹¹',
    nameEn: 'Eungjidang',
    nw: [37.579595432157966, 126.97667876079947],
    se: [37.57955041200325, 126.9768287778653]
  },
  {
    id: 'gyeongseongjeon',
    name: 'ê²½ì„±ì „',
    nameEn: 'Gyeongseongjeon',
    nw: [37.579534628470896, 126.97674670564773],
    se: [37.5793566949806, 126.97681185646736]
  },
  {
    id: 'gangnyeongjeon',
    name: 'ê°•ë…•ì „',
    nameEn: 'Gangnyeongjeon',
    nw: [37.57947608222901, 126.97684012187166],
    se: [37.57938156638848, 126.97729581968161]
  },
  {
    id: 'heumgyeonggak',
    name: 'í ê²½ê°',
    nameEn: 'Heumgyeonggak',
    nw: [37.57972153988065, 126.97652022734192],
    se: [37.5796810316051, 126.97670420635653]
  },
  {
    id: 'gyotaejeon',
    name: 'êµíƒœì „',
    nameEn: 'Gyotaejeon',
    nw: [37.57989055382053, 126.97691358021297],
    se: [37.57982529770065, 126.97725323109862]
  },
  {
    id: 'sajeongjeon',
    name: 'ì‚¬ì •ì „',
    nameEn: 'Sajeongjeon',
    nw: [37.579045873149205, 126.97691950147181],
    se: [37.57898059787739, 126.97716009067494]
  },
  {
    id: 'manchunjeon',
    name: 'ë§Œì¶˜ì „',
    nameEn: 'Manchunjeon',
    nw: [37.579057211291925, 126.97731006930693],
    se: [37.57899192120716, 126.97747707237069]
  },
  {
    id: 'geungjeongjeon',
    name: 'ê¸ì •ì „',
    nameEn: 'Geungjeongjeon',
    nw: [37.57881379918469, 126.97657428653042],
    se: [37.57796927076278, 126.9773613427869]
  },
  {
    id: 'gyejodang',
    name: 'ê³„ì¡°ë‹¹',
    nameEn: 'Gyejodang',
    nw: [37.57794005256122, 126.97769814362223],
    se: [37.57773738094997, 126.97797556142645]
  }
];

// ì ì´ ì‚¬ê°í˜• í´ë¦¬ê³¤ ì•ˆì— ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
function isPointInPolygon(lat, lng, polygon) {
  // GPS ì˜¤ì°¨ë¥¼ ê³ ë ¤í•œ ì—¬ìœ  ë²”ìœ„ (ì•½ 5ë¯¸í„°)
  const buffer = 0.00005; // ì•½ 5ë¯¸í„° ì •ë„ì˜ ì—¬ìœ 

  // ë¶ì„œ(NW)ì™€ ë‚¨ë™(SE) ì¢Œí‘œë¥¼ ì´ìš©í•œ ì‚¬ê°í˜• ì˜ì—­ ì²´í¬ (ë²„í¼ ì ìš©)
  const northLat = polygon.nw[0] + buffer;  // ë¶ìª½ ìœ„ë„ (í™•ì¥)
  const westLng = polygon.nw[1] - buffer;   // ì„œìª½ ê²½ë„ (í™•ì¥)
  const southLat = polygon.se[0] - buffer;  // ë‚¨ìª½ ìœ„ë„ (í™•ì¥)
  const eastLng = polygon.se[1] + buffer;   // ë™ìª½ ê²½ë„ (í™•ì¥)

  console.log(`ğŸ” í´ë¦¬ê³¤ ì²´í¬: ${polygon.name}`);
  console.log(`   GPS: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);

  const latInRange = lat <= northLat && lat >= southLat;
  const lngInRange = lng >= westLng && lng <= eastLng;

  const isInside = latInRange && lngInRange;
  console.log(`   ê²°ê³¼: ${isInside ? 'âœ… ë‚´ë¶€' : 'âŒ ì™¸ë¶€'}`);

  return isInside;
}

// GPS ìœ„ì¹˜ë¡œ í•´ë‹¹í•˜ëŠ” ê±´ë¬¼ í´ë¦¬ê³¤ ì°¾ê¸°
function findBuildingByPolygon(lat, lng) {
  console.log(`ğŸ›ï¸ í´ë¦¬ê³¤ ê²€ìƒ‰: ìœ„ì¹˜ ${lat.toFixed(6)}, ${lng.toFixed(6)}`);

  for (const polygon of buildingPolygons) {
    if (isPointInPolygon(lat, lng, polygon)) {
      console.log(`ğŸ¯ í´ë¦¬ê³¤ ë§¤ì¹­ ì„±ê³µ: ${polygon.name}`);
      
      // í´ë¦¬ê³¤ IDë¥¼ ê¸°ì¡´ ê±´ë¬¼ ë°ì´í„° IDë¡œ ë§¤í•‘
      const buildingId = mapPolygonToBuilding(polygon.id);
      const buildingData = gyeongbokgungBuildings[buildingId];
      
      if (buildingData) {
        return {
          ...buildingData,
          distance: 0, // í´ë¦¬ê³¤ ì•ˆì— ìˆìœ¼ë¯€ë¡œ ê±°ë¦¬ëŠ” 0
          isInPolygon: true,
          polygonData: polygon
        };
      } else {
        // ê¸°ë³¸ ê±´ë¬¼ ì •ë³´ ìƒì„±
        return {
          id: polygon.id,
          name: polygon.name,
          nameEn: polygon.nameEn,
          description: `${polygon.name}ì€ ê²½ë³µê¶ì˜ ì¤‘ìš”í•œ ê±´ë¬¼ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.`,
          detailedDescription: `${polygon.name}ì€ ì¡°ì„ ì‹œëŒ€ì˜ ê±´ì¶• ì–‘ì‹ì„ ì˜ ë³´ì—¬ì£¼ëŠ” ë¬¸í™”ì¬ì…ë‹ˆë‹¤.`,
          coordinates: {
            lat: (polygon.nw[0] + polygon.se[0]) / 2,
            lng: (polygon.nw[1] + polygon.se[1]) / 2
          },
          buildYear: 'ì¡°ì„ ì‹œëŒ€',
          culturalProperty: 'ë¬¸í™”ì¬',
          features: ['ì „í†µ ê±´ì¶•', 'ê²½ë³µê¶ ê±´ë¬¼'],
          distance: 0,
          isInPolygon: true,
          polygonData: polygon
        };
      }
    }
  }

  console.log('âŒ í•´ë‹¹í•˜ëŠ” í´ë¦¬ê³¤ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  return null;
}

// í´ë¦¬ê³¤ IDë¥¼ ê¸°ì¡´ ê±´ë¬¼ ë°ì´í„° IDë¡œ ë§¤í•‘
function mapPolygonToBuilding(polygonId) {
  const mapping = {
    'eungjidang': 'eungjidang',
    'gyeongseongjeon': 'gyeongseungjeon', // ê²½ì„±ì „
    'gangnyeongjeon': 'gangnyeongjeon',
    'heumgyeonggak': 'heumgyeonggak',
    'gyotaejeon': 'gyotaejeon',
    'sajeongjeon': 'sajeongjeon',
    'manchunjeon': 'manchunjeon',
    'geungjeongjeon': 'geunjeongjeon', // ê¸ì •ì „ -> ê·¼ì •ì „
    'gyejodang': 'gyejodang'
  };

  return mapping[polygonId] || polygonId;
}

// ë‘ ì¢Œí‘œ ê°„ì˜ ê±°ë¦¬ ê³„ì‚° (ë¯¸í„° ë‹¨ìœ„) - í´ë°±ìš©
function calculateDistance(lat1, lng1, lat2, lng2) {
  const R = 6371e3; // ì§€êµ¬ ë°˜ì§€ë¦„ (ë¯¸í„°)
  const Ï†1 = lat1 * Math.PI / 180;
  const Ï†2 = lat2 * Math.PI / 180;
  const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
  const Î”Î» = (lng2 - lng1) * Math.PI / 180;

  const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
    Math.cos(Ï†1) * Math.cos(Ï†2) *
    Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

  return R * c;
}

// ê²½ë³µê¶ ì˜ì—­ í™•ì¸
function isInGyeongbokgung(lat, lng) {
  // ê²½ë³µê¶ ëŒ€ëµì ì¸ ê²½ê³„ (ì‚¬ê°í˜• ì˜ì—­)
  const bounds = {
    north: 37.5820,
    south: 37.5760,
    east: 126.9790,
    west: 126.9750
  };

  return lat >= bounds.south && lat <= bounds.north &&
    lng >= bounds.west && lng <= bounds.east;
}

// ê°„ë‹¨í•œ ì£¼ì†Œ ìƒì„± (í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì‹¤ì œ ì£¼ì†Œ ì¡°íšŒ)
function getAddressFromCoordinates(isInside, buildingName) {
  if (isInside) {
    return 'ì„œìš¸íŠ¹ë³„ì‹œ ì¢…ë¡œêµ¬ ì‚¬ì§ë¡œ 161 (ê²½ë³µê¶)';
  }

  // í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì‹¤ì œ ì£¼ì†Œë¡œ ëŒ€ì²´ë  í”Œë ˆì´ìŠ¤í™€ë”
  return `í˜„ì¬ ìœ„ì¹˜ (${buildingName} ì¸ê·¼)`;
}

// API ë¼ìš°íŠ¸ë“¤

// ìœ„ì¹˜ í™•ì¸ API
app.post('/api/check-location', (req, res) => {
  try {
    const { latitude, longitude } = req.body;

    if (!latitude || !longitude) {
      return res.status(400).json({
        success: false,
        message: 'ìœ„ë„ì™€ ê²½ë„ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    const lat = parseFloat(latitude);
    const lng = parseFloat(longitude);

    // í´ë¦¬ê³¤ ê¸°ë°˜ ê±´ë¬¼ ì‹ë³„
    const building = findBuildingByPolygon(lat, lng);
    const isInside = isInGyeongbokgung(lat, lng);

    if (building) {
      const locationMessage = isInside
        ? `ğŸ“ ${building.name} (${building.distance}m) - ì´¬ì˜ ê°€ëŠ¥`
        : `ğŸ“ ${building.name} (${building.distance}m) - ê²½ë³µê¶ ë°–ì—ì„œ ì´¬ì˜`;

      return res.json({
        success: true,
        message: locationMessage,
        inGyeongbokgung: isInside,
        nearBuilding: true,
        building: {
          id: building.id,
          name: building.name,
          nameEn: building.nameEn,
          distance: building.distance
        }
      });
    } else {
      return res.json({
        success: true,
        message: 'ìœ„ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        inGyeongbokgung: isInside,
        nearBuilding: false
      });
    }

  } catch (error) {
    console.error('ìœ„ì¹˜ í™•ì¸ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// ì‚¬ì§„ ë¶„ì„ API
app.post('/api/analyze-photo', upload.single('photo'), async (req, res) => {
  try {
    const { latitude, longitude } = req.body;

    if (!req.file) {
      return res.status(400).json({
        success: false,
        message: 'ì‚¬ì§„ì´ ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'
      });
    }

    if (!latitude || !longitude) {
      return res.status(400).json({
        success: false,
        message: 'ìœ„ì¹˜ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }

    const lat = parseFloat(latitude);
    const lng = parseFloat(longitude);

    console.log(`ì‚¬ì§„ ë¶„ì„ ìš”ì²­: ${req.file.filename}, ìœ„ì¹˜: ${lat}, ${lng}`);

    // í´ë¦¬ê³¤ ê¸°ë°˜ ê±´ë¬¼ ì‹ë³„
    const building = findBuildingByPolygon(lat, lng);
    const isInside = isInGyeongbokgung(lat, lng);

    if (building) {
      // ì¢Œí‘œ ê¸°ë°˜ ì‹¤ì œ ì£¼ì†Œ ì¶”ì •
      const actualAddress = getAddressFromCoordinates(isInside, building.name);

      return res.json({
        success: true,
        message: `${building.name}ì„(ë¥¼) ì‹ë³„í–ˆìŠµë‹ˆë‹¤!`,
        building: building,
        photoUrl: `/uploads/${req.file.filename}`,
        analysisResult: {
          confidence: 0.95, // ì‹ ë¢°ë„ (í…ŒìŠ¤íŠ¸ìš©)
          detectedFeatures: building.features,
          location: {
            latitude: lat,
            longitude: lng,
            accuracy: 'high',
            address: actualAddress,
            capturedAt: new Date().toISOString(),
            distanceToBuilding: building.distance,
            isInGyeongbokgung: isInside
          }
        }
      });
    } else {
      return res.json({
        success: false,
        message: 'ê±´ë¬¼ì„ ì‹ë³„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        photoUrl: `/uploads/${req.file.filename}`,
        inGyeongbokgung: isInside
      });
    }

  } catch (error) {
    console.error('ì‚¬ì§„ ë¶„ì„ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      message: 'ì‚¬ì§„ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// ê±´ë¬¼ ì •ë³´ ì¡°íšŒ API
app.get('/api/building/:id', (req, res) => {
  try {
    const buildingId = req.params.id;
    const building = gyeongbokgungBuildings[buildingId];

    if (!building) {
      return res.status(404).json({
        success: false,
        message: 'ê±´ë¬¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    res.json({
      success: true,
      building: building
    });

  } catch (error) {
    console.error('ê±´ë¬¼ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// ëª¨ë“  ê±´ë¬¼ ëª©ë¡ ì¡°íšŒ API
app.get('/api/buildings', (req, res) => {
  try {
    const buildingList = Object.values(gyeongbokgungBuildings).map(building => ({
      id: building.id,
      name: building.name,
      nameEn: building.nameEn,
      description: building.description,
      coordinates: building.coordinates,
      culturalProperty: building.culturalProperty
    }));

    res.json({
      success: true,
      buildings: buildingList,
      total: buildingList.length
    });

  } catch (error) {
    console.error('ê±´ë¬¼ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// ê±´ë¬¼ ì² í•™ ìƒì„± API
app.post('/api/philosophy/:id', async (req, res) => {
  try {
    const buildingId = req.params.id;
    const { buildingName, locationInfo, userContext } = req.body;

    console.log(`ğŸ›ï¸ ì² í•™ ìƒì„± ìš”ì²­: ${buildingId} (${buildingName})`);

    // ê±´ë¬¼ ì •ë³´ ì¡°íšŒ (ê¸°ì¡´ ë°ì´í„° ìš°ì„ , ì—†ìœ¼ë©´ í´ë¦¬ê³¤ ë°ì´í„°ì—ì„œ ìƒì„±)
    let building = gyeongbokgungBuildings[buildingId];
    
    if (!building) {
      // í´ë¦¬ê³¤ ë°ì´í„°ì—ì„œ ê±´ë¬¼ ì •ë³´ ì°¾ê¸°
      const polygon = buildingPolygons.find(p => p.id === buildingId);
      if (polygon) {
        building = {
          id: polygon.id,
          name: polygon.name,
          nameEn: polygon.nameEn,
          description: `${polygon.name}ì€ ê²½ë³µê¶ì˜ ì¤‘ìš”í•œ ê±´ë¬¼ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.`,
          detailedDescription: `${polygon.name}ì€ ì¡°ì„ ì‹œëŒ€ì˜ ê±´ì¶• ì–‘ì‹ì„ ì˜ ë³´ì—¬ì£¼ëŠ” ë¬¸í™”ì¬ì…ë‹ˆë‹¤.`,
          coordinates: {
            lat: (polygon.nw[0] + polygon.se[0]) / 2,
            lng: (polygon.nw[1] + polygon.se[1]) / 2
          },
          buildYear: 'ì¡°ì„ ì‹œëŒ€',
          culturalProperty: 'ë¬¸í™”ì¬',
          features: ['ì „í†µ ê±´ì¶•', 'ê²½ë³µê¶ ê±´ë¬¼']
        };
        console.log(`ğŸ“ í´ë¦¬ê³¤ì—ì„œ ê±´ë¬¼ ì •ë³´ ìƒì„±: ${building.name}`);
      }
    }
    
    if (!building) {
      return res.status(404).json({
        success: false,
        error: 'ê±´ë¬¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }

    // ê¸°ë³¸ ìœ„ì¹˜ ì •ë³´ ì„¤ì •
    const defaultLocationInfo = {
      address: 'ì„œìš¸íŠ¹ë³„ì‹œ ì¢…ë¡œêµ¬ ì‚¬ì§ë¡œ 161 (ê²½ë³µê¶)',
      latitude: building.coordinates.lat,
      longitude: building.coordinates.lng,
      distanceToBuilding: 0,
      heading: null,
      ...locationInfo
    };

    // BedrockServiceë¥¼ í†µí•´ ì² í•™ ìƒì„±
    const philosophyResult = await bedrockService.generateBuildingPhilosophy(
      building,
      defaultLocationInfo,
      userContext || {}
    );

    console.log(`âœ… ì² í•™ ìƒì„± ì™„ë£Œ: ${buildingName}`);

    res.json(philosophyResult);

  } catch (error) {
    console.error('âŒ ì² í•™ ìƒì„± ì˜¤ë¥˜:', error);
    
    // ì˜¤ë¥˜ ë°œìƒ ì‹œ í´ë°± ì‘ë‹µ
    const building = gyeongbokgungBuildings[req.params.id];
    const buildingName = req.body.buildingName || building?.name || 'ê±´ë¬¼';
    
    res.status(500).json({
      success: false,
      error: 'ì² í•™ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      buildingName: buildingName,
      content: {
        philosophy: `${buildingName}ì˜ ê±´ì¶• ì² í•™ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`,
        history: `${buildingName}ì˜ ì—­ì‚¬ì  ë§¥ë½ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`,
        culture: `${buildingName}ì˜ ë¬¸í™”ì  ê°€ì¹˜ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`,
        modern: `${buildingName}ì˜ í˜„ëŒ€ì  í•´ì„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`
      },
      fallback: true
    });
  }
});

// React ë¼ìš°í„°ë¥¼ ìœ„í•œ catch-all í•¸ë“¤ëŸ¬ (API ë¼ìš°íŠ¸ ì´í›„ì— ë°°ì¹˜)
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, '../front/build', 'index.html'));
});

// uploads í´ë” ìƒì„±
const fs = require('fs');
if (!fs.existsSync('uploads')) {
  fs.mkdirSync('uploads');
}

// ì„œë²„ ì‹œì‘
app.listen(PORT, () => {
  console.log(`ê²½ë³µê¶ ê±´ë¬¼ ì¸ì‹ API ì„œë²„ê°€ í¬íŠ¸ ${PORT}ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.`);
  console.log(`API ì—”ë“œí¬ì¸íŠ¸:`);
  console.log(`- POST /api/check-location : ìœ„ì¹˜ í™•ì¸`);
  console.log(`- POST /api/analyze-photo : ì‚¬ì§„ ë¶„ì„`);
  console.log(`- GET /api/building/:id : ê±´ë¬¼ ì •ë³´ ì¡°íšŒ`);
  console.log(`- GET /api/buildings : ëª¨ë“  ê±´ë¬¼ ëª©ë¡`);
  console.log(`- POST /api/philosophy/:id : ê±´ë¬¼ ì² í•™ ìƒì„± (AWS Bedrock)`);
});